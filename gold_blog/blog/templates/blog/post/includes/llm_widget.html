{% load static %}
<link rel="stylesheet" href="{% static 'blog/css/llm_widget.css' %}?v=20260205">
<div class="sidebar-widget-llm">
  <div id="history-container" class="llm-chat-history" aria-live="polite"></div>
  {% include "blog/post/includes/llm_chat_component.html" %}
</div>
<script>
  const historyEl = document.getElementById("llm-history");
  const history = historyEl ? JSON.parse(historyEl.textContent || "[]") : [];

  const escapeHtml = (value) =>
    String(value).replace(/[&<>"']/g, (char) => {
      const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      };
      return map[char] || char;
    });

  const waitingMarkup = () =>
    `
      <span class="llm-wait" role="status" aria-live="polite">
        <span class="llm-wait__letter">W</span>
        <span class="llm-wait__dots" aria-hidden="true">
          <span></span><span></span><span></span>
        </span>
      </span>
    `.trim();

  function renderHistory() {
    const container = document.getElementById("history-container");
    container.innerHTML = "";
    history.forEach((item) => {
      const entry = document.createElement("div");
      entry.className = "llm-chat-entry";
      entry.innerHTML = `
        <div class="llm-chat-row llm-chat-row--user">
          <div class="llm-chat-bubble llm-chat-bubble--user">
            <div class="llm-chat-msg">${escapeHtml(item.prompt)}</div>
          </div>
        </div>
        <div class="llm-chat-row llm-chat-row--ai">
          <div class="llm-chat-bubble llm-chat-bubble--ai">
            <div class="llm-chat-msg">${item.response}</div>
          </div>
        </div>
      `;
      container.appendChild(entry);
    });
    container.scrollTop = container.scrollHeight;
  }
  renderHistory();


  const form = document.getElementById("llm-form");
  const promptInput = document.getElementById("id_prompt");
  if (form && promptInput) {
    const sendBtn = form.querySelector('button[type="submit"]');
    const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfInput ? csrfInput.value : "";
    const maxInputHeight = 152;

    const autoGrow = () => {
      promptInput.style.height = "auto";
      const next = Math.min(promptInput.scrollHeight, maxInputHeight);
      promptInput.style.height = `${next}px`;
      promptInput.style.overflowY =
        promptInput.scrollHeight > maxInputHeight ? "auto" : "hidden";
    };

    autoGrow();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const prompt = promptInput.value.trim();
      if (!prompt) return;
      sendBtn.disabled = true;
      let aiResponse = waitingMarkup();
      history.push({ prompt: prompt, response: aiResponse });
      renderHistory();

      const response = await fetch("{% url 'blog:llm_generate' %}", {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        credentials: "same-origin",
        body: new URLSearchParams({ prompt: prompt }),
      });

      let data = {};
      try {
        data = await response.json();
      } catch (err) {
        data = {};
      }
      if (!response.ok) {
        aiResponse = data.error || `Request failed (${response.status}).`;
      } else {
        aiResponse = data.generated || data.error || "Something went wrong.";
      }
      history[history.length - 1].response = aiResponse;
      renderHistory();
      promptInput.value = "";
      autoGrow();
      sendBtn.disabled = false;
      promptInput.focus();
    });

    promptInput.addEventListener("input", autoGrow);

    promptInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event("submit"));
      }
    });
  }
</script>
