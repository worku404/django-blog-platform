{% extends "blog/base.html" %}
{% load static %}
{% block sidebar %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'blog/css/llm.css' %}?v=20260121">
{% endblock %}
{% block content %}
<div class="llm-chat-container">
<p><a href="{% url 'blog:post_list' %}" class="llm-back-link">â† Back</a></p>
  <div class="llm-chat-title">áˆ°áˆ‹áˆ áˆ°áˆ‹áˆ áˆ°á‹á‰½ áŠ¥áŠ•á‹´á‰µ áŠ“á‰½áˆğŸ™‹â€â™‚ï¸ğŸ™‹â€â™‚ï¸ áˆáŠ• áˆá‰³á‹˜á‹ áˆáŠ• á‹­áˆáŒ£â˜ºï¸</div>
  <div id="history-container" class="llm-chat-history"></div>
  <form id="llm-form" autocomplete="off">
    <div class="llm-chat-input-row">
      {{ llm_form.prompt }}
      <button type="submit" class="llm--btn llm-chat-send-btn" aria-label="Send">
        <span class="llm--icon">â¤</span>
      </button>
    </div>
  </form>
</div>
<script>
const history = [];

function renderHistory() {
    const container = document.getElementById('history-container');
    container.innerHTML = '';
    history.forEach(item => {
        const entry = document.createElement('div');
        entry.className = 'llm-chat-entry';
        entry.innerHTML = `
            <div class="llm-chat-user">You:</div>
            <div class="llm-chat-user-msg">${item.prompt}</div>
            <div class="llm-chat-ai">AI:</div>
            <div class="llm-chat-ai-msg">${item.response}</div>
        `;
        container.appendChild(entry);
    });
    container.scrollTop = container.scrollHeight;
}

const form = document.getElementById('llm-form');
const promptInput = document.getElementById('id_prompt');
const sendBtn = form.querySelector('button[type="submit"]');

form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const prompt = promptInput.value.trim();
    if (!prompt) return;
    sendBtn.disabled = true;
    let aiResponse = "Generating...";
    history.push({prompt: prompt, response: aiResponse});
    renderHistory();

    const response = await fetch("{% url 'blog:llm_generate' %}", {
        method: "POST",
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({prompt: prompt})
    });

    const data = await response.json();
    aiResponse = data.generated || data.error || "Something went wrong.";
    history[history.length - 1].response = aiResponse;
    renderHistory();
    promptInput.value = "";
    sendBtn.disabled = false;
    promptInput.focus();
});

// Send on Enter (but allow Shift+Enter for newline)
promptInput.addEventListener('keydown', function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
    }
});
</script>
{% endblock %}