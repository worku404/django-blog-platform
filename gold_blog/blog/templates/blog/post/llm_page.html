{% extends "blog/base.html" %}
{% load static %}
{% block sidebar %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'blog/css/llm_widget.css' %}?v=20260205">
<link rel="stylesheet" href="{% static 'blog/css/llm.css' %}?v=20260205">
{% endblock %}
{% block content %}
<section class="llm-page">
  <div class="llm-page__header">
    <a href="{% url 'blog:post_list' %}" class="llm-back-link">&larr; Back</a>
    <h1 class="llm-page__title">Chat with AI</h1>
  </div>
  <div id="history-container" class="llm-chat-history" aria-live="polite"></div>
  {% include "blog/post/includes/llm_chat_component.html" %}
</section>
{{ llm_history|json_script:"llm-history" }}
<script>
  const historyEl = document.getElementById("llm-history");
  const history = historyEl ? JSON.parse(historyEl.textContent || "[]") : [];

  const escapeHtml = (value) =>
    String(value).replace(/[&<>"']/g, (char) => {
      const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      };
      return map[char] || char;
    });

  function renderHistory() {
    const container = document.getElementById("history-container");
    container.innerHTML = "";
    history.forEach((item) => {
      const entry = document.createElement("div");
      entry.className = "llm-chat-entry";
      entry.innerHTML = `
        <div class="llm-chat-user">You</div>
        <div class="llm-chat-user-msg">${escapeHtml(item.prompt)}</div>
        <div class="llm-chat-ai">AI</div>
        <div class="llm-chat-ai-msg">${item.response}</div>
      `;
      container.appendChild(entry);
    });
    container.scrollTop = container.scrollHeight;
  }
  renderHistory();

  const form = document.getElementById("llm-form");
  const promptInput = document.getElementById("id_prompt");
  if (form && promptInput) {
    const sendBtn = form.querySelector('button[type="submit"]');
    const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfInput ? csrfInput.value : "";
    const maxInputHeight = 220;

    const autoGrow = () => {
      promptInput.style.height = "auto";
      const next = Math.min(promptInput.scrollHeight, maxInputHeight);
      promptInput.style.height = `${next}px`;
      promptInput.style.overflowY =
        promptInput.scrollHeight > maxInputHeight ? "auto" : "hidden";
    };

    autoGrow();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const prompt = promptInput.value.trim();
      if (!prompt) return;
      sendBtn.disabled = true;
      let aiResponse = "Generating...";
      history.push({ prompt: prompt, response: aiResponse });
      renderHistory();

      const response = await fetch("{% url 'blog:llm_generate' %}", {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        credentials: "same-origin",
        body: new URLSearchParams({ prompt: prompt }),
      });

      let data = {};
      try {
        data = await response.json();
      } catch (err) {
        data = {};
      }
      if (!response.ok) {
        aiResponse = data.error || `Request failed (${response.status}).`;
      } else {
        aiResponse = data.generated || data.error || "Something went wrong.";
      }
      history[history.length - 1].response = aiResponse;
      renderHistory();
      promptInput.value = "";
      autoGrow();
      sendBtn.disabled = false;
      promptInput.focus();
    });

    promptInput.addEventListener("input", autoGrow);

    promptInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event("submit"));
      }
    });
  }
</script>
{% endblock %}
