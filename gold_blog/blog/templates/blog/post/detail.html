{% extends "blog/base.html" %}
{% load blog_tags %}
{% load static %}

{% block title %}{{ post.title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'blog/css/detail.css' %}?v=20260205">
{% endblock %}

{% block content %}
<article class="post">
  <header class="post__header">
    {% comment %} <p class="post__kicker">Article </p><span class='total_views'>
              {{total_views}} view{{total_views|pluralize}}
        </span></span> {% endcomment %}

    <h1 class="post__title">{{ post.title }}</h1>

    <div class="post__meta">
      <span class="meta__item">
        <span class="meta__label">Published
        <time datetime="{{ post.publish|date:'c' }}">{{ post.publish|date:"M d, Y" }}</time>
      </span>

      <span class="meta__dot" aria-hidden="true">•</span>

      <span class="meta__item">
        <span class="meta__label">Author</span>
        <span>{{ post.author }}</span>
        
      </span>
    </div>
    {% if post.tags.all %}
      <nav class="tagrow" aria-label="Tags">
        {% for t in post.tags.all %}
          <a class="chip" href="{% url 'blog:post_list_by_tag' t.slug %}">#{{ t.name }}</a>
        {% endfor %}
      </nav>
    {% endif %}
  </header>

  <section class="post__body prose">
   {{ post.body|markdown}}
  </section>
   <div class="share">
        <a href="{% url 'blog:post_share' post.id %}" class="share-btn">
        <svg class="share-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="18" cy="5" r="3"></circle>
          <circle cx="6" cy="12" r="3"></circle>
          <circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
        <span>Share</span>
      </a>
      {% with total_likes=post.users_like.count likers=post.users_like.all %}
          <div class='like-container'>
            <span class='count'>
              <span class='total'>{{ total_likes }}</span>
            </span>
            <button
              type="button"
              data-id="{{ post.id }}"
              data-action="{% if request.user in likers %}unlike{% else %}like{% endif %}"
              class='like like-btn'
            >
              {% if request.user in likers %}
                unlike
              {% else %}
                like
              {% endif %}
            </button>
          </div>
        {% endwith %}
    </div>
  {% if similar_posts %}
    <section class="panel">
      <div class="panel__head">
        <h2 class="panel__title">Similar posts</h2>
        <p class="panel__sub">More writing in the same direction.</p>
      </div>

      <div class="similar" role="list">
        {% for p in similar_posts %}
          <a class="similar__card" role="listitem" href="{{ p.get_absolute_url }}">
            <div class="similar__top">
              <span class="pill">Recommended</span>
              <span class="pill pill--muted">{{ p.publish|date:"M d, Y" }}</span>
            </div>
            <h3 class="similar__title">{{ p.title|truncatechars:50 }}</h3>
            <p class="similar__hint">Open →</p>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  <section class="panel" id="comments">
  {% comment %}
    <div class="panel__head">
      <h2 class="panel__title">
        Comment{{comments.count|pluralize}}
        <span class="count">{{ comments.count }}</span>
      </h2>
      <p class="panel__sub">Join the discussion. Be respectful.</p>
    </div>

    {% if comments %}
      <ol class="commentlist">
        {% for c in comments %}
          <li class="comment">
            <div class="comment__top">
              <p></p>
              <time class="comment__time" datetime="{{ c.created|date:'c' }}">
              <span class="comment__author">@{{ request.user }}</span>
                {{ c.created|date:"M d, Y • H:i" }}
              </time>
            </div>
            <div class="comment__body">
              {{ c.body|linebreaks }}
            </div>
          </li>
        {% endfor %}
      </ol>
    {% if has_more_comments %}
      <div class="cform__actions">
        <a class="btn btn--soft"
           href="?climit={{ next_comment_limit }}#comments">
          See more comments
        </a>
      </div>
    {% endif %}
    {% else %}
     {% endcomment %}
      <div class="empty">
        <h3 class="empty__title">No comments yet</h3>
        {% comment %} <p class="empty__text">Be the first to leave a comment.</p> {% endcomment %}
        <p class="empty__text">Comments are temporarily disabled due to storage limitations.</p>
      </div>
       {% comment %}
    {% endif %} 

    <div class="formwrap">
      <h3 class="formwrap__title">Leave a comment</h3>
        <form class="cform" action="{% url 'blog:post_comment' post.id %}" method="post" novalidate> 
              {% csrf_token %}

            <div class="cform__grid">
              <div class="cform__field">
                {{ comment_form.name.as_field_group }}
              </div>

              <div class="cform__field">
                {{ comment_form.email.as_field_group }}
              </div>
            </div>

            <div class="cform__field cform__field--full">
              {{ comment_form.body.as_field_group }}
            </div>
            <div class="cform__actions">
                <button class="btn-pill btn-teal" type="submit">Add comment</button>
            </div> {% endcomment %}
            {% comment %} <div class="cform__actions">
                <button class="btn btn--primary cform__submit" type="submit">Add comment</button>
            </div>
        </form>
         
    </div>
    {% endcomment %}
  </section>
  <div class="post__footer">
    <a class="btn btn--soft" href="{% url 'blog:post_list' %}">← Back to posts</a>
    <a class="btn btn--ghost" href="{% url 'blog:home' %}">Home</a>
  </div>
</article>
<!-- Footer -->
  {% include "blog/post/includes/footer.html" %}
{% endblock %}
{% block domready %}
  const url = '{% url 'blog:like' %}';
  var options ={
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }
document.querySelector('button.like')
  .addEventListener('click', function(e) {
    e.preventDefault();
    var likeButton = this;
    var formData = new FormData();
    formData.append('id', likeButton.dataset.id);
    formData.append('action', likeButton.dataset.action);
    options['body'] = formData;
    fetch(url, options)
      .then(response => response.json())
      .then(data => {
        if (data['status'] === 'ok') {
          // Toggle action
          var previousAction = likeButton.dataset.action;
          var action = previousAction === 'like' ? 'unlike' : 'like';
          likeButton.dataset.action = action;
          likeButton.innerHTML = action === 'like' ? 'like' : 'unlike';
          // Always use the count from the server!
          var likeCount = document.querySelector('span.total');
          likeCount.innerHTML = data['total_likes'];
        }
      });
  });
{% endblock %}
